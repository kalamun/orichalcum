<?php 
/* (c) Kalamun.org - GNU/GPL 3 */

define("PAGE_NAME","Maintenance:Anti-malware");
include_once("../inc/head.inc.php");

/* AZIONI */
if(isset($_GET['check']))
{
	$results = array();
	
	// check for malware
	$r = recursiveAntiMalware();
	if(is_array($r)) $results = array_merge($results, $r);
	
	// check upload dir
	$r = checkUploadDir();
	if(is_array($r)) $results = array_merge($results, $r);
}

if(isset($success)) echo '<div id="MsgSuccess">'.$success.'</div>';
elseif(isset($alert)) echo '<div id="MsgAlert">'.$alert.'</div>';
/* FINE AZIONI */

?>
<h1><?= $kaTranslate->translate(PAGE_NAME); ?></h1>
<br />

<?php
if(!empty($results))
{
	?>
	<table class="tabella">
		<tr>
			<th><?= $kaTranslate->translate('Maintenance:File path'); ?></th>
			<th><?= $kaTranslate->translate('UI:Actions'); ?></th>
		</tr>
		<?php
		foreach($results as $i=>$r)
		{
			$filename = trim(substr($r, 0, strpos($r, ":")));
			?>
			<tr id="result<?= $i; ?>">
				<td><?= $r; ?></td>
				<td><small class="actions">
					<a href="javascript:viewFile('<?= base64_encode($filename); ?>', <?= $i; ?>);" class="smallbutton"><?= $kaTranslate->translate('Maintenance:View Source'); ?></a>
					<a href="javascript:if(confirm('<?= htmlentities($kaTranslate->translate('Maintenance: Are you sure that you want to delete this file?')); ?>')) deleteFile('<?= base64_encode($filename); ?>', <?= $i; ?>);" class="smallalertbutton"><?= $kaTranslate->translate('Maintenance:Delete File'); ?></a>
					<a href="javascript:quarantineFile('<?= base64_encode($filename); ?>', <?= $i; ?>);" class="smallalertbutton"><?= $kaTranslate->translate('Maintenance:Quarantine File'); ?></a>
					</small></td>
			</tr>
			<?php
		}
		?>
	</table>
	
	<script type="text/javascript">
		function deleteFile(file, id)
		{
			var aj = new kAjax();
			aj.onSuccess(function() {
				var tr = document.getElementById('result'+id);
				if(tr) tr.parentNode.removeChild(tr);
				});
				
			aj.send("post", "ajax/antimalwareHandler.php", "delete="+file);
		}
		
		function quarantineFile(file, id)
		{
			var aj = new kAjax();
			aj.onSuccess(function() {
				var tr = document.getElementById('result'+id);
				if(tr) tr.parentNode.removeChild(tr);
				});
				
			aj.send("post", "ajax/antimalwareHandler.php", "quarantine="+file);
		}
	</script>
	<?php
}
?>

<form action="" method="get">
	<input type="submit" name="check" class="button" value="<?= addslashes($kaTranslate->translate('Maintenance:Check for malware now!')); ?>">
</form>

<br />

<?php 
include_once("../inc/foot.inc.php");


/* FUNCTIONS */

// check files for common traces of intrusions
function recursiveAntiMalware($dir="")
{
	if(empty($dir)) $dir = rtrim($_SERVER['DOCUMENT_ROOT'], "/ ").BASEDIR;
	$dir = rtrim($dir, "/. ")."/";
	$nicedir = substr($dir, strlen($_SERVER['DOCUMENT_ROOT']));
	
	$results = array();
	if(!file_exists($dir) || !is_dir($dir)) return $results;

	foreach(scandir($dir) as $file)
	{
		// skip . and ..
		if(trim($file, " .") == "") continue;
		
		// skip self
		if(rtrim($dir, "/. ") == rtrim(str_replace('\\','/',getcwd()) , "/. ") && $file == basename($_SERVER['PHP_SELF'])) continue;
		
		// scan files
		if(is_file($dir.$file))
		{
			$r = checkFileForMalware($dir.$file);
			if(!empty($r)) $results[] = $nicedir.$file.': '.$r;
		
		// recursive for each dir
		} elseif(is_dir($dir.$file)) {
			$results = array_merge($results, recursiveAntiMalware($dir.$file));
		}
	}
	
	return $results;
}

function checkFileForMalware($file)
{
	if(!file_exists($file) || !is_file($file)) return false;

	$f = file_get_contents($file);
	
	// check for eval function
	if(strpos($f, "/eval(/")!==false) return "This file contains an eval() function: I'm quite sure that it's malware";
	
	// check for hex chars
	if(substr($file,-4)=='.php' && strpos($f, "/\x/")!==false) return "This file contains hexadecimal chars: it is probably malware";
}


// check upload dir for .php files
function checkUploadDir($dir="")
{
	if(empty($dir))
	{
		$dir_arch = substr(DIR_TEMP, 0, strrpos( trim(DIR_TEMP,"/"), "/"));
		$dir = rtrim($_SERVER['DOCUMENT_ROOT'], "/ ").BASEDIR.$dir_arch.'/';
	}
	$dir = rtrim($dir, "/. ")."/";
	$nicedir = substr($dir, strlen($_SERVER['DOCUMENT_ROOT']));
	
	$results = array();
	if(!file_exists($dir) || !is_dir($dir)) return $results;
	
	foreach(scandir($dir) as $file)
	{
		// skip . and ..
		if(trim($file, " .") == "") continue;
		
		// scan files
		if(is_file($dir.$file))
		{
			if(substr($file,-4)=='.php' || substr($file,-5)=='.php3') $results[] = $nicedir.$file.' : it\'s strange to find a PHP file inside the upload dir, isn\'t it? Probably it is malware';
		
		// recursive for each dir
		} elseif(is_dir($dir.$file)) {
			$results = array_merge($results, checkUploadDir($dir.$file));
		}
	}
	
	return $results;
}

// check db for common blacklisted words
function checkDBBlackList()
{
	
}
